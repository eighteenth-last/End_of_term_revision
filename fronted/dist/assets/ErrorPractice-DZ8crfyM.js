import{u as oe,a as re,s as ie,r as i,x as S,o as ce,c as f,b as n,l as y,w as a,d as u,h as V,k as de,A as ve,e as s,f as b,y as pe,F as h,m as w,t as I,C as L,p as _e}from"./index-CLO37vWr.js";const me={key:1,style:{display:"flex",gap:"16px","margin-top":"24px"}},fe={style:{flex:"1"}},ge={key:0},ye={key:1},be={style:{width:"300px",position:"sticky",top:"24px","align-self":"flex-start"}},ke={style:{display:"grid","grid-template-columns":"repeat(5, 1fr)",gap:"8px"}},je={__name:"ErrorPractice",setup(he){const k=oe(),P=ve(),R=re(),{userId:j}=ie(R),$=i(!1),z=i(!1),A=i(!1),B=i(!1),E=i([]),C=i([]),x=i([]),g=i([]),c=i({}),d=i({}),v=i({subject_id:null,question_counts:{single:0,multiple:0,judge:0,fill:0}}),D=[{label:"单选题",value:"single"},{label:"多选题",value:"multiple"},{label:"判断题",value:"judge"},{label:"填空题",value:"fill"}],Q=S(()=>E.value.map(t=>({label:t.name,value:t.id}))),Z=S(()=>{let t=0;return g.value.forEach(e=>{e.type==="multiple"?d.value[e.id]&&d.value[e.id].length>0&&t++:c.value[e.id]&&t++}),t}),G=S(()=>v.value.subject_id?Object.values(v.value.question_counts).reduce((t,e)=>t+e,0)>0:!1),H=t=>({single:"单选题",multiple:"多选题",judge:"判断题",fill:"填空题"})[t]||t,N=t=>{const e=t.match(/^([A-Z])\./);return e?e[1]:t},J=t=>{const e=g.value[t];return e?e.type==="multiple"?d.value[e.id]&&d.value[e.id].length>0:c.value[e.id]&&c.value[e.id].trim()!=="":!1},K=t=>{const e=document.getElementById(`question-${t}`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})},W=async()=>{$.value=!0;try{E.value=await de.list(j.value)}catch(t){k.error(t.message||"加载科目列表失败")}finally{$.value=!1}},X=async t=>{try{const e=await L.getTypes(t,j.value);C.value=e.types,x.value=[],v.value.question_counts={single:0,multiple:0,judge:0,fill:0}}catch(e){k.error(e.message||"获取题型失败")}},Y=async()=>{z.value=!0;try{const t=await L.practice({user_id:j.value,subject_id:v.value.subject_id,question_counts:v.value.question_counts});g.value=t.questions,B.value=!0;const e={},o={};t.questions.forEach(p=>{p.type==="multiple"?o[p.id]=[]:e[p.id]=""}),c.value=e,d.value=o}catch(t){k.error(t.message||"开始练习失败")}finally{z.value=!1}},q=async()=>{const t=g.value.filter(e=>e.type==="multiple"?!d.value[e.id]||d.value[e.id].length===0:!c.value[e.id]);if(t.length>0){k.warning(`还有 ${t.length} 题未作答`);return}A.value=!0;try{const e=g.value.map(p=>({question_id:p.id,user_answer:p.type==="multiple"?(d.value[p.id]||[]).sort().join(","):c.value[p.id]||""})),o=await _e.submit({user_id:j.value,subject_id:v.value.subject_id,answers:e});k.success(`提交成功！正确 ${o.correct} 题，错误 ${o.wrong} 题，准确率 ${o.accuracy}%，成绩 ${o.grade}`),setTimeout(()=>{P.push("/practice-history")},1500)}catch(e){k.error(e.message||"提交失败")}finally{A.value=!1}};return ce(()=>{W()}),(t,e)=>{const o=u("n-button"),p=u("n-page-header"),ee=u("n-select"),O=u("n-form-item"),te=u("n-alert"),M=u("n-checkbox"),le=u("n-input-number"),_=u("n-space"),F=u("n-checkbox-group"),U=u("n-card"),ae=u("n-text"),ne=u("n-radio"),se=u("n-radio-group"),ue=u("n-input");return s(),f("div",null,[n(p,{title:"错题练习",subtitle:"针对错题进行专项练习"},{extra:a(()=>[n(o,{onClick:e[0]||(e[0]=l=>t.$router.push("/errors"))},{default:a(()=>[...e[3]||(e[3]=[b(" 返回错题集 ",-1)])]),_:1})]),_:1}),B.value?(s(),f("div",me,[V("div",fe,[n(_,{vertical:"",size:"large"},{default:a(()=>[(s(!0),f(h,null,w(g.value,(l,m)=>(s(),y(U,{key:l.id,title:`${m+1}.(${H(l.type)}) ${l.question}`,id:`question-${m}`},{default:a(()=>[n(_,{vertical:"",size:"large"},{default:a(()=>[n(ae,{strong:"",style:{"font-size":"14px",color:"#666"}},{default:a(()=>[b("分值: "+I(l.score||2)+"分",1)]),_:2},1024),l.type==="single"||l.type==="judge"?(s(),f("div",ge,[n(se,{value:c.value[l.id],"onUpdate:value":r=>c.value[l.id]=r},{default:a(()=>[n(_,{vertical:""},{default:a(()=>[(s(!0),f(h,null,w(l.options,(r,T)=>(s(),y(ne,{key:T,value:N(r),label:r,size:"large"},null,8,["value","label"]))),128))]),_:2},1024)]),_:2},1032,["value","onUpdate:value"])])):l.type==="multiple"?(s(),f("div",ye,[n(F,{value:d.value[l.id],"onUpdate:value":r=>d.value[l.id]=r},{default:a(()=>[n(_,{vertical:""},{default:a(()=>[(s(!0),f(h,null,w(l.options,(r,T)=>(s(),y(M,{key:T,value:N(r),label:r,size:"large"},null,8,["value","label"]))),128))]),_:2},1024)]),_:2},1032,["value","onUpdate:value"])])):(s(),y(ue,{key:2,value:c.value[l.id],"onUpdate:value":r=>c.value[l.id]=r,placeholder:"请输入答案",size:"large"},null,8,["value","onUpdate:value"]))]),_:2},1024)]),_:2},1032,["title","id"]))),128))]),_:1})]),V("div",be,[n(U,{title:`答题卡 (${Z.value}/${g.value.length})`,size:"small"},{default:a(()=>[n(_,{vertical:"",size:"large"},{default:a(()=>[V("div",ke,[(s(!0),f(h,null,w(g.value,(l,m)=>(s(),y(o,{key:m,type:J(m)?"primary":"default",size:"medium",onClick:r=>K(m),style:{width:"100%"}},{default:a(()=>[b(I(m+1),1)]),_:2},1032,["type","onClick"]))),128))]),n(o,{type:"primary",block:"",size:"large",loading:A.value,onClick:q},{default:a(()=>[...e[7]||(e[7]=[b(" 提交 ",-1)])]),_:1},8,["loading"])]),_:1})]),_:1},8,["title"])])])):(s(),y(U,{key:0,title:"配置练习",style:{"margin-top":"24px"}},{default:a(()=>[n(_,{vertical:"",size:"large"},{default:a(()=>[n(O,{label:"选择科目"},{default:a(()=>[n(ee,{value:v.value.subject_id,"onUpdate:value":[e[1]||(e[1]=l=>v.value.subject_id=l),X],options:Q.value,placeholder:"请选择科目",loading:$.value},null,8,["value","options","loading"])]),_:1}),n(O,{label:"错题题型与数量"},{default:a(()=>[n(_,{vertical:"",style:{width:"100%"}},{default:a(()=>[C.value.length===0?(s(),y(te,{key:0,type:"warning"},{default:a(()=>[...e[4]||(e[4]=[b(" 该科目下暂无错题 ",-1)])]),_:1})):pe("",!0),n(F,{value:x.value,"onUpdate:value":e[2]||(e[2]=l=>x.value=l)},{default:a(()=>[n(_,{vertical:""},{default:a(()=>[(s(),f(h,null,w(D,l=>n(_,{key:l.value,align:"center"},{default:a(()=>[n(M,{value:l.value,label:l.label,disabled:!C.value.includes(l.value)},null,8,["value","label","disabled"]),n(le,{value:v.value.question_counts[l.value],"onUpdate:value":m=>v.value.question_counts[l.value]=m,min:0,max:100,disabled:!x.value.includes(l.value),style:{width:"120px"}},{suffix:a(()=>[...e[5]||(e[5]=[b("题",-1)])]),_:1},8,["value","onUpdate:value","disabled"])]),_:2},1024)),64))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),n(o,{type:"primary",size:"large",disabled:!G.value,loading:z.value,onClick:Y,block:""},{default:a(()=>[...e[6]||(e[6]=[b(" 开始练习 ",-1)])]),_:1},8,["disabled","loading"])]),_:1})]),_:1}))])}}};export{je as default};
